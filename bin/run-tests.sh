#!/usr/bin/env bash
set -e

# Synopsis:
# Test the test runner by running it against a predefined set of solutions 
# with an expected output.

# Output:
# Outputs the diff of the expected test results against the actual test results
# generated by the test runner.

# Example:
# ./bin/run-tests.sh

# The bats tests are all the same. Let's generate that file:
test_template=$(cat <<'END_TEMPLATE'

@test "%s" {
    slug="%s"
    dir="tests/$slug"

    run bin/run.sh "$slug" "$dir" "$dir"

    ((status == 0))
    result=$(< "$dir"/analysis.json)
    expected=$(< "$dir"/expected_analysis.json)
    [[ "$result" == "$expected" ]]
}
END_TEMPLATE
)

{
    echo '#!/usr/bin/env bats'
    for dir in tests/*/; do
        slug=$(basename "$dir")
        # shellcheck disable=SC2059
        printf "$test_template"'\n' "$slug" "$slug"
    done 
} > tests/all_tests.bats

# now run it
bats tests
